<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador del bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: true, securityLevel: "loose" });
    </script>
</head>
<body class="bg-slate-100 min-h-screen">
<div class="max-w-7xl mx-auto p-4 md:p-8 space-y-5">
    <header class="bg-slate-900 text-white p-6 rounded-2xl">
        <h1 class="text-2xl font-bold">Editor Conversacional del Bot</h1>
        <p class="text-sm text-slate-200 mt-1">Cada mensaje incluye su texto, su tipo de interacción y sus opciones.</p>
    </header>

    {% if messages %}
        <section class="space-y-2">
            {% for message in messages %}
                <div class="rounded-lg px-3 py-2 border {% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-700{% else %}bg-emerald-50 border-emerald-200 text-emerald-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </section>
    {% endif %}

    <section class="grid grid-cols-1 xl:grid-cols-5 gap-5">
        <aside class="xl:col-span-2 space-y-4">
            <article class="bg-white rounded-2xl border p-4">
                <h2 class="font-bold text-slate-800">Mapa del flujo</h2>
                <div class="mt-3 overflow-x-auto"><div class="mermaid min-w-[480px]">{{ mermaid_code }}</div></div>
            </article>

            <article class="bg-white rounded-2xl border p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold">Orden de mensajes</h2>
                    <a href="/servicios-manager/" class="text-xs text-cyan-700">Servicios y eventos</a>
                </div>
                <ul id="lista-nodos" data-url="{% url 'bot_manager_reorder_nodes' %}" class="space-y-2">
                    {% for node in nodes %}
                        <li data-id="{{ node.id }}" class="sortable-item border rounded-lg p-3 bg-slate-50">
                            <div class="flex gap-2">
                                <button type="button" class="drag-handle text-slate-400">⋮⋮</button>
                                <div class="flex-1">
                                    <a href="/bot-manager/?node={{ node.id }}" class="font-semibold text-slate-800">{{ forloop.counter }}. {{ node.title }}</a>
                                    <p class="text-xs text-slate-500">{{ node.get_interaction_type_display }}</p>
                                    <div class="text-[11px] mt-1 space-x-1">
                                        {% if node.is_start %}<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">Inicio</span>{% endif %}
                                        {% if node.is_terminal %}<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded">Final</span>{% endif %}
                                        {% if not node.is_active %}<span class="bg-slate-200 text-slate-700 px-2 py-0.5 rounded">Inactivo</span>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% empty %}
                        <li class="text-sm text-slate-500">No hay mensajes.</li>
                    {% endfor %}
                </ul>
            </article>

            <article class="bg-white rounded-2xl border p-4">
                <h2 class="font-bold mb-3">Crear mensaje</h2>
                <form method="post" action="{% url 'bot_manager_create_node' %}" class="space-y-3" data-node-form>
                    {% csrf_token %}
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-600">Nombre del mensaje <span class="text-rose-600">*</span></label>
                        <input name="title" required placeholder="Ejemplo: Mensaje de bienvenida" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-600">Texto del mensaje <span class="text-rose-600">*</span></label>
                        <textarea name="message_text" rows="3" required placeholder="Mensaje que enviará el bot" class="w-full border rounded p-2 text-sm"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-semibold uppercase text-slate-600">Tipo de interacción <span class="text-rose-600">*</span></label>
                        <select name="interaction_type" class="w-full border rounded p-2 text-sm" data-node-interaction>
                            {% for value,label in interaction_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="hidden space-y-2" data-node-section="option_list">
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Título del menú</label>
                            <input name="menu_title" placeholder="Ejemplo: ¿Qué deseas hacer?" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Descripción del menú</label>
                            <input name="menu_description" placeholder="Texto auxiliar del menú" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Texto del botón del menú</label>
                            <input name="menu_button_text" value="Ver opciones" class="w-full border rounded p-2 text-sm">
                        </div>
                    </div>
                    <div class="hidden space-y-2" data-node-section="url_button">
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Texto del botón de enlace <span class="text-rose-600">*</span></label>
                            <input name="link_button_text" placeholder="Ejemplo: Abrir agenda" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">URL del botón <span class="text-rose-600">*</span></label>
                            <input name="link_button_url" placeholder="https://..." class="w-full border rounded p-2 text-sm">
                        </div>
                    </div>
                    <label class="text-sm inline-flex gap-2"><input type="checkbox" name="set_as_start"> Definir como inicio</label>
                    <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear</button>
                </form>
            </article>
        </aside>

        <main class="xl:col-span-3 space-y-4">
            {% if selected_node %}
                <article class="bg-white rounded-2xl border p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold">Editar mensaje: {{ selected_node.title }}</h2>
                        <form method="post" action="{% url 'bot_manager_delete_node' selected_node.id %}" onsubmit="return confirm('¿Eliminar mensaje y opciones?');">
                            {% csrf_token %}
                            <button class="bg-rose-600 text-white px-3 py-2 rounded text-sm">Eliminar mensaje</button>
                        </form>
                    </div>
                    <form method="post" action="{% url 'bot_manager_update_node' selected_node.id %}" class="grid grid-cols-1 md:grid-cols-2 gap-3" data-node-form>
                        {% csrf_token %}
                        <div><label class="text-xs font-semibold uppercase text-slate-600">Nombre <span class="text-rose-600">*</span></label><input name="title" value="{{ selected_node.title }}" required class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="text-xs font-semibold uppercase text-slate-600">Identificador interno</label><input value="{{ selected_node.key }}" readonly class="w-full border rounded p-2 text-sm bg-slate-100 text-slate-600"></div>
                        <div class="md:col-span-2"><label class="text-xs font-semibold uppercase text-slate-600">Texto del mensaje <span class="text-rose-600">*</span></label><textarea name="message_text" rows="3" required class="w-full border rounded p-2 text-sm">{{ selected_node.message_text }}</textarea></div>
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Tipo de interacción <span class="text-rose-600">*</span></label>
                            <select name="interaction_type" class="w-full border rounded p-2 text-sm" data-node-interaction>
                                {% for value,label in interaction_choices %}
                                    <option value="{{ value }}" {% if selected_node.interaction_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div><label class="text-xs font-semibold uppercase text-slate-600">Siguiente por defecto</label>
                            <select name="default_next_id" class="w-full border rounded p-2 text-sm">
                                <option value="">Sin siguiente paso</option>
                                {% for node in nodes %}{% if node.id != selected_node.id %}<option value="{{ node.id }}" {% if selected_node.default_next_id == node.id %}selected{% endif %}>{{ node.title }}</option>{% endif %}{% endfor %}
                            </select>
                        </div>
                        <div class="md:col-span-2 hidden grid grid-cols-1 md:grid-cols-3 gap-2" data-node-section="option_list">
                            <div><label class="text-xs font-semibold uppercase text-slate-600">Título del menú</label><input name="menu_title" value="{{ selected_node.menu_title }}" class="w-full border rounded p-2 text-sm"></div>
                            <div><label class="text-xs font-semibold uppercase text-slate-600">Descripción del menú</label><input name="menu_description" value="{{ selected_node.menu_description }}" class="w-full border rounded p-2 text-sm"></div>
                            <div><label class="text-xs font-semibold uppercase text-slate-600">Texto del botón del menú</label><input name="menu_button_text" value="{{ selected_node.menu_button_text }}" class="w-full border rounded p-2 text-sm"></div>
                        </div>
                        <div class="md:col-span-2 hidden grid grid-cols-1 md:grid-cols-2 gap-2" data-node-section="url_button">
                            <div><label class="text-xs font-semibold uppercase text-slate-600">Texto del botón de enlace <span class="text-rose-600">*</span></label><input name="link_button_text" value="{{ selected_node.link_button_text }}" class="w-full border rounded p-2 text-sm"></div>
                            <div><label class="text-xs font-semibold uppercase text-slate-600">URL del botón <span class="text-rose-600">*</span></label><input name="link_button_url" value="{{ selected_node.link_button_url }}" class="w-full border rounded p-2 text-sm"></div>
                        </div>
                        <div class="md:col-span-2 flex flex-wrap items-center gap-4">
                            <label class="text-sm inline-flex gap-2"><input type="checkbox" name="is_active" {% if selected_node.is_active %}checked{% endif %}> Activo</label>
                            <label class="text-sm inline-flex gap-2"><input type="checkbox" name="is_terminal" {% if selected_node.is_terminal %}checked{% endif %}> Final</label>
                            <label class="text-sm inline-flex gap-2"><input type="checkbox" name="set_as_start" {% if selected_node.is_start %}checked{% endif %}> Inicio</label>
                            <button class="ml-auto bg-slate-900 text-white px-4 py-2 rounded text-sm">Guardar mensaje</button>
                        </div>
                    </form>
                </article>

                <article class="bg-white rounded-2xl border p-4 space-y-3">
                    <h3 class="font-bold">Opciones de este mensaje</h3>
                    <p class="text-xs text-slate-500">Cada opción muestra solo los campos necesarios según la acción seleccionada.</p>
                    <ul id="lista-opciones" data-url="{% url 'bot_manager_reorder_options' selected_node.id %}" class="space-y-2">
                        {% for option in selected_options %}
                            <li data-id="{{ option.id }}" class="sortable-item border rounded-lg p-3 bg-slate-50">
                                <div class="flex gap-2">
                                    <button type="button" class="drag-handle text-slate-400">⋮⋮</button>
                                    <div class="flex-1 space-y-2">
                                        <form method="post" action="{% url 'bot_manager_update_option' option.id %}" class="grid grid-cols-1 md:grid-cols-2 gap-2" data-option-form>
                                            {% csrf_token %}
                                            <div><label class="text-xs font-semibold uppercase text-slate-600">Texto de opción <span class="text-rose-600">*</span></label><input name="title" value="{{ option.title }}" required class="w-full border rounded p-2 text-sm"></div>
                                            <div><label class="text-xs font-semibold uppercase text-slate-600">ID interno</label><input value="{{ option.trigger_key }}" readonly class="w-full border rounded p-2 text-sm bg-slate-100 text-slate-600"></div>
                                            <div class="md:col-span-2"><label class="text-xs font-semibold uppercase text-slate-600">Descripción</label><input name="description" value="{{ option.description }}" class="w-full border rounded p-2 text-sm"></div>
                                            <div>
                                                <label class="text-xs font-semibold uppercase text-slate-600">Acción <span class="text-rose-600">*</span></label>
                                                <select name="action_type" class="w-full border rounded p-2 text-sm" data-option-action>
                                                    {% for value,label in option_action_choices %}<option value="{{ value }}" {% if option.action_type == value %}selected{% endif %}>{{ label }}</option>{% endfor %}
                                                </select>
                                            </div>
                                            <div class="hidden" data-action-section="go_to_message">
                                                <label class="text-xs font-semibold uppercase text-slate-600">Mensaje destino <span class="text-rose-600">*</span></label>
                                                <select name="next_node_id" class="w-full border rounded p-2 text-sm">
                                                    <option value="">Selecciona mensaje</option>
                                                    {% for node in nodes %}{% if node.id != selected_node.id %}<option value="{{ node.id }}" {% if option.next_node_id == node.id %}selected{% endif %}>{{ node.title }}</option>{% endif %}{% endfor %}
                                                </select>
                                            </div>
                                            <div class="hidden" data-action-section="quote_service,book_service">
                                                <label class="text-xs font-semibold uppercase text-slate-600">Servicio relacionado <span class="text-rose-600">*</span></label>
                                                <select name="service_id" class="w-full border rounded p-2 text-sm">
                                                    <option value="">Selecciona servicio</option>
                                                    {% for service in services %}<option value="{{ service.id }}" {% if option.service_id == service.id %}selected{% endif %}>{{ service.name }}</option>{% endfor %}
                                                </select>
                                            </div>
                                            <div class="md:col-span-2 hidden" data-action-section="open_link">
                                                <label class="text-xs font-semibold uppercase text-slate-600">Enlace <span class="text-rose-600">*</span></label>
                                                <input name="external_url" value="{{ option.external_url }}" placeholder="https://..." class="w-full border rounded p-2 text-sm">
                                            </div>
                                            <div class="md:col-span-2 flex items-center justify-between">
                                                <label class="text-sm inline-flex gap-2"><input type="checkbox" name="is_active" {% if option.is_active %}checked{% endif %}> Opción activa</label>
                                                <button class="bg-slate-900 text-white px-3 py-2 rounded text-sm">Guardar opción</button>
                                            </div>
                                        </form>
                                        <form method="post" action="{% url 'bot_manager_delete_option' option.id %}" onsubmit="return confirm('¿Eliminar opción?');">{% csrf_token %}<button class="text-sm text-rose-700">Eliminar opción</button></form>
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="text-sm text-slate-500">Este mensaje aún no tiene opciones.</li>
                        {% endfor %}
                    </ul>

                    <form method="post" action="{% url 'bot_manager_create_option' selected_node.id %}" class="grid grid-cols-1 md:grid-cols-2 gap-2 border rounded-lg p-3 bg-slate-50" data-option-form>
                        {% csrf_token %}
                        <div><label class="text-xs font-semibold uppercase text-slate-600">Texto de opción <span class="text-rose-600">*</span></label><input name="title" required placeholder="Ejemplo: Quiero agendar" class="w-full border rounded p-2 text-sm"></div>
                        <div><label class="text-xs font-semibold uppercase text-slate-600">ID interno</label><input value="Se genera automáticamente" readonly class="w-full border rounded p-2 text-sm bg-slate-100 text-slate-600"></div>
                        <div class="md:col-span-2"><label class="text-xs font-semibold uppercase text-slate-600">Descripción</label><input name="description" class="w-full border rounded p-2 text-sm"></div>
                        <div>
                            <label class="text-xs font-semibold uppercase text-slate-600">Acción <span class="text-rose-600">*</span></label>
                            <select name="action_type" class="w-full border rounded p-2 text-sm" data-option-action>
                                {% for value,label in option_action_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="hidden" data-action-section="go_to_message">
                            <label class="text-xs font-semibold uppercase text-slate-600">Mensaje destino <span class="text-rose-600">*</span></label>
                            <select name="next_node_id" class="w-full border rounded p-2 text-sm">
                                <option value="">Selecciona mensaje</option>
                                {% for node in nodes %}{% if node.id != selected_node.id %}<option value="{{ node.id }}">{{ node.title }}</option>{% endif %}{% endfor %}
                            </select>
                        </div>
                        <div class="hidden" data-action-section="quote_service,book_service">
                            <label class="text-xs font-semibold uppercase text-slate-600">Servicio relacionado <span class="text-rose-600">*</span></label>
                            <select name="service_id" class="w-full border rounded p-2 text-sm">
                                <option value="">Selecciona servicio</option>
                                {% for service in services %}<option value="{{ service.id }}">{{ service.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="md:col-span-2 hidden" data-action-section="open_link">
                            <label class="text-xs font-semibold uppercase text-slate-600">Enlace <span class="text-rose-600">*</span></label>
                            <input name="external_url" placeholder="https://..." class="w-full border rounded p-2 text-sm">
                        </div>
                        <div class="md:col-span-2 text-right"><button class="bg-emerald-600 text-white px-4 py-2 rounded text-sm">Agregar opción</button></div>
                    </form>
                </article>
            {% else %}
                <article class="bg-white rounded-2xl border p-4 text-slate-600">Crea un mensaje para comenzar.</article>
            {% endif %}
        </main>
    </section>
</div>
<script>
function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2){return parts.pop().split(";").shift();}return "";}
async function persistOrder(url, ids){if(!url){return;}await fetch(url,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify({ids})});}
function setupSortable(elementId){const container=document.getElementById(elementId);if(!container){return;}Sortable.create(container,{animation:150,handle:".drag-handle",draggable:".sortable-item",onEnd:async()=>{const ids=Array.from(container.querySelectorAll(".sortable-item")).map((item)=>Number(item.dataset.id)).filter((id)=>!Number.isNaN(id));await persistOrder(container.dataset.url,ids);}});}

function applyNodeVisibility(form){
    const select=form.querySelector("[data-node-interaction]");
    if(!select){return;}
    const interaction=select.value;
    form.querySelectorAll("[data-node-section]").forEach((section)=>{
        const shouldShow=section.dataset.nodeSection===interaction;
        section.classList.toggle("hidden",!shouldShow);
    });
}

function applyOptionVisibility(form){
    const select=form.querySelector("[data-option-action]");
    if(!select){return;}
    const action=select.value;
    form.querySelectorAll("[data-action-section]").forEach((section)=>{
        const actions=section.dataset.actionSection.split(",").map((item)=>item.trim());
        const shouldShow=actions.includes(action);
        section.classList.toggle("hidden",!shouldShow);
    });
}

document.addEventListener("DOMContentLoaded",()=>{
    setupSortable("lista-nodos");
    setupSortable("lista-opciones");
    document.querySelectorAll("[data-node-form]").forEach((form)=>{
        applyNodeVisibility(form);
        form.querySelector("[data-node-interaction]")?.addEventListener("change",()=>applyNodeVisibility(form));
    });
    document.querySelectorAll("[data-option-form]").forEach((form)=>{
        applyOptionVisibility(form);
        form.querySelector("[data-option-action]")?.addEventListener("change",()=>applyOptionVisibility(form));
    });
});
</script>
</body>
</html>
